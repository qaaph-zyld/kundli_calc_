# Deployment Guide

This guide will help you deploy the Kundli Calculator to production.

## Architecture

- **Frontend:** Vercel (Next.js)
- **Backend:** Railway (FastAPI + PostgreSQL)
- **Database (Auth):** Supabase (included in free tier)

---

## Part 1: Deploy Backend to Railway

### Prerequisites
- Railway account (free at [railway.app](https://railway.app))
- GitHub account

### Step 1: Create Railway Account
1. Go to [railway.app](https://railway.app)
2. Click "Start a New Project"
3. Sign in with GitHub

### Step 2: Deploy Backend
1. Click "New Project"
2. Select "Deploy from GitHub repo"
3. Choose your `kundli_calc_` repository
4. Railway will auto-detect the FastAPI app
5. Click "Deploy Now"

### Step 3: Add PostgreSQL Database
1. In your Railway project, click "New"
2. Select "Database" > "PostgreSQL"
3. Railway will provision a Postgres database
4. Connection string will be auto-generated

### Step 4: Configure Environment Variables
1. Click on your FastAPI service
2. Go to "Variables" tab
3. Add these variables:
   ```
   DATABASE_URL=${{Postgres.DATABASE_URL}}
   REDIS_URL=redis://red-xxxxx.railway.app:6379
   CORS_ORIGINS=https://your-app.vercel.app
   ```
4. Railway will auto-inject the DATABASE_URL

### Step 5: Add Redis (Optional but Recommended)
1. Click "New" > "Database" > "Redis"
2. Copy the Redis connection URL
3. Add it to your FastAPI service variables

### Step 6: Set Root Directory
1. In FastAPI service settings
2. Set "Root Directory" to: `backend`
3. Set "Start Command" to: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`

### Step 7: Get Your Backend URL
1. After deployment, Railway provides a public URL
2. Example: `https://kundli-calc-backend.railway.app`
3. Save this URL - you'll need it for frontend

### Step 8: Run Database Migrations
1. In Railway, go to your service
2. Click "Settings" > "Deploy"
3. Add "Startup Command":
   ```bash
   alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $PORT
   ```

---

## Part 2: Deploy Frontend to Vercel

### Prerequisites
- Vercel account (free at [vercel.com](https://vercel.com))
- Supabase project (see SUPABASE_SETUP.md)

### Step 1: Create Vercel Account
1. Go to [vercel.com](https://vercel.com)
2. Click "Sign Up"
3. Sign in with GitHub

### Step 2: Import Project
1. Click "New Project"
2. Select "Import Git Repository"
3. Choose your `kundli_calc_` repository
4. Vercel will auto-detect Next.js

### Step 3: Configure Build Settings
1. **Root Directory:** `frontend/next-app`
2. **Framework Preset:** Next.js
3. **Build Command:** `npm run build` (auto-detected)
4. **Output Directory:** `.next` (auto-detected)

### Step 4: Add Environment Variables
Click "Environment Variables" and add:

```env
NEXT_PUBLIC_API_BASE_URL=https://your-backend.railway.app
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

**Where to find these:**
- **API_BASE_URL:** Your Railway backend URL from Part 1, Step 7
- **SUPABASE_URL:** From Supabase dashboard > Settings > API
- **SUPABASE_ANON_KEY:** From Supabase dashboard > Settings > API

### Step 5: Deploy
1. Click "Deploy"
2. Wait 2-3 minutes for build to complete
3. You'll get a URL like: `https://kundli-calc.vercel.app`

### Step 6: Update Backend CORS
1. Go back to Railway
2. Update `CORS_ORIGINS` variable:
   ```
   CORS_ORIGINS=https://kundli-calc.vercel.app,https://*.vercel.app
   ```
3. Railway will auto-redeploy

### Step 7: Test Your Deployment
1. Visit your Vercel URL
2. Try generating a chart
3. Try signing up/logging in
4. Try saving a chart

---

## Part 3: Custom Domain (Optional)

### For Vercel (Frontend)
1. In Vercel project settings, go to "Domains"
2. Add your custom domain (e.g., `kundlicalc.com`)
3. Update DNS records as instructed
4. SSL certificate auto-generated by Vercel

### For Railway (Backend)
1. In Railway service settings, go to "Settings"
2. Click "Generate Domain" or add custom domain
3. Update frontend `NEXT_PUBLIC_API_BASE_URL` to new domain

---

## Cost Estimates

### Free Tier (Perfect for Getting Started)

**Vercel Free:**
- 100 GB bandwidth/month
- Unlimited deployments
- Custom domains
- SSL certificates
- **Cost:** $0/month

**Railway Free Trial:**
- $5 credit/month
- ~500 hours runtime
- PostgreSQL + Redis included
- **Cost:** $0/month (with trial credit)

**Supabase Free:**
- 500 MB database
- 2 GB bandwidth
- 50,000 monthly active users
- **Cost:** $0/month

### After Free Tier

**Railway Pro:**
- $5/month per service
- ~$10/month total (FastAPI + Postgres)

**Vercel Pro:** (Only if you exceed free limits)
- $20/month
- Includes analytics and team features

**Total Monthly Cost:** ~$10/month (Railway only)

---

## Monitoring & Logs

### Vercel Logs
1. Go to your project
2. Click "Deployments" tab
3. Click any deployment > "View Function Logs"

### Railway Logs
1. Go to your service
2. Click "Deployments" tab
3. View real-time logs

### Supabase Logs
1. Go to your project
2. Click "Logs" in sidebar
3. Filter by "Auth" or "Database"

---

## Troubleshooting

### Frontend can't connect to backend
- Check `NEXT_PUBLIC_API_BASE_URL` in Vercel
- Verify Railway service is running
- Check CORS settings in Railway

### Authentication not working
- Verify Supabase credentials in Vercel
- Check Supabase dashboard for auth errors
- Ensure database schema is created

### Database connection errors
- Check Railway Postgres is running
- Verify migrations ran successfully
- Check DATABASE_URL is set correctly

### Build failures
- Check build logs in Vercel/Railway
- Verify all dependencies in package.json
- Check Node.js version compatibility

---

## Continuous Deployment

Both Vercel and Railway support automatic deployments:

1. Push to `master` branch
2. GitHub webhook triggers deploy
3. Vercel rebuilds frontend
4. Railway rebuilds backend
5. Changes live in ~2-3 minutes!

---

## Security Checklist

- [ ] Environment variables set correctly
- [ ] CORS configured for production domain
- [ ] Supabase RLS policies enabled
- [ ] Database credentials secured
- [ ] API rate limiting enabled (optional)
- [ ] HTTPS enabled (auto by Vercel/Railway)

---

## Next Steps

After deployment:
1. Share your app URL with friends for feedback
2. Monitor usage in Vercel/Railway/Supabase dashboards
3. Add Google Analytics (optional)
4. Set up error tracking with Sentry (optional)
5. Add more features (Navamsa chart, etc.)

---

## Support

If you encounter issues:
- **Vercel:** [vercel.com/docs](https://vercel.com/docs)
- **Railway:** [docs.railway.app](https://docs.railway.app)
- **Supabase:** [supabase.com/docs](https://supabase.com/docs)

Congratulations! Your Kundli Calculator is now live! ðŸŽ‰ðŸš€
