# Basic configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecDataDir /tmp/modsecurity/data
SecTmpDir /tmp/modsecurity/tmp
SecUploadDir /tmp/modsecurity/upload
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 1
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsecurity/audit.log
SecAuditLogParts ABCFHZ

# Rule sets
# SQL Injection Protection
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@detectSQLi" \
    "id:942100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,t:removeWhitespace,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    severity:'CRITICAL',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}'"

# XSS Protection
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_HEADERS:User-Agent|REQUEST_HEADERS:Referer|ARGS_NAMES|ARGS|XML:/* "@detectXSS" \
    "id:941100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    severity:'CRITICAL',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}'"

# File Upload Protection
SecRule FILES_NAMES "@rx .*\.(?:php|phtml|php3|php4|php5|php7|pht|phar|inc)$" \
    "id:944100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:lowercase,\
    msg:'Malicious File Upload Attempt',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    severity:'CRITICAL',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-file-upload'"

# Rate Limiting
SecRule IP:REQUESTS "@gt 100" \
    "id:990100,\
    phase:1,\
    deny,\
    status:429,\
    msg:'Rate Limit Exceeded',\
    expirevar:IP:REQUESTS=60,\
    setvar:IP:REQUESTS=+1"

# Blocking Known Bad Bots
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile bots-blacklist.txt" \
    "id:990200,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Known Bad Bot Detected',\
    tag:'application-multi',\
    tag:'platform-multi',\
    tag:'attack-bot'"

# Geolocation Blocking (if needed)
# SecGeoLookupDb /usr/share/GeoIP/GeoLite2-Country.mmdb
# SecRule GEO:COUNTRY_CODE "@pm CN RU NK" \
#     "id:990300,\
#     phase:1,\
#     deny,\
#     status:403,\
#     msg:'Access from blocked country'"
